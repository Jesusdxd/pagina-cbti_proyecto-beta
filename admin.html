<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - CBT</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ===== ESTILOS GLOBALES ===== */
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f9f9f9;
            color: #333;
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        body.dark-mode {
            background-color: #121212;
            color: #ffffff;
        }

        /* ===== HEADER ===== */
        header {
            background-color: #2E7D32;
            color: white;
            padding: 10px 20px;
            text-align: center;
            font-size: 1.2rem;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideDown 0.5s ease-in-out;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }

        header h1 {
            margin: 0;
            font-size: 1.2rem;
        }

        /* ===== BREADCRUMBS (Navegaci√≥n) ===== */
        .breadcrumbs {
            padding: 10px 15px;
            background-color: #e9e9e9;
            border-radius: 5px;
            font-size: 0.9rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        body.dark-mode .breadcrumbs {
            background-color: #2a2a2a;
            color: #ddd;
        }

        .breadcrumbs span {
            color: #2E7D32;
            font-weight: bold;
            margin: 0 5px;
        }

        body.dark-mode .breadcrumbs span {
            color: #4CAF50;
        }

        .breadcrumbs span:first-child {
            margin-left: 0;
        }

        /* ===== BOTONES DEL HEADER ===== */
        .header-buttons {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logout-button {
            background-color: #d32f2f;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin-left: 10px;
        }

        .logout-button:hover {
            background-color: #c62828;
            transform: scale(1.05);
        }

        .logout-button:active {
            transform: scale(0.95);
        }

        /* Bot√≥n de modo oscuro */
        .dark-mode-toggle {
            background-color: #333;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: background-color 0.3s ease, transform 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dark-mode-toggle:hover {
            background-color: #555;
            transform: scale(1.05);
        }

        body.dark-mode .dark-mode-toggle {
            background-color: #4CAF50;
            color: white;
        }

        body.dark-mode .dark-mode-toggle:hover {
            background-color: #45a049;
        }

        /* Input de b√∫squeda */
        #search-input {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            font-size: 0.9rem;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        body.dark-mode #search-input {
            background-color: #333;
            color: white;
        }

        /* ===== CONTENIDO PRINCIPAL ===== */
        main {
            margin-top: 60px;
            padding: 20px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        /* ===== CAJAS DE CONTENIDO ===== */
        .content-box {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            transition: box-shadow 0.3s ease, transform 0.3s ease, background-color 0.3s ease, color 0.3s ease;
            animation: fadeIn 0.5s ease-in-out;
        }

        body.dark-mode .content-box {
            background-color: #1e1e1e;
            color: #ffffff;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .content-box:hover {
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
            transform: translateY(-5px);
        }

        .content-box h2 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #2E7D32;
            cursor: pointer;
            transition: color 0.3s ease;
            display: flex;
            align-items: center;
        }

        .content-box h2:hover {
            color: #1B5E20;
        }

        body.dark-mode .content-box h2 {
            color: #4CAF50;
        }

        body.dark-mode .content-box h2:hover {
            color: #81C784;
        }

        /* ===== DASHBOARD MEJORADO ===== */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-box {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-box:hover {
            transform: translateY(-5px);
        }

        .stat-box.highlight {
            border-left: 4px solid #4CAF50;
        }

        .stat-box.warning {
            border-left: 4px solid #FFC107;
        }

        .stat-icon {
            font-size: 2rem;
            display: block;
            margin-bottom: 10px;
            color: #2E7D32;
        }

        .stat-box h3 {
            margin: 0;
            font-size: 1.2rem;
            color: #333;
        }

        .stat-box p {
            margin: 10px 0;
            font-size: 1.8rem;
            font-weight: bold;
            color: #2E7D32;
        }

        .stat-box small {
            display: block;
            font-size: 0.8rem;
            color: #666;
        }

        body.dark-mode .stat-box {
            background-color: #252525;
        }

        body.dark-mode .stat-icon {
            color: #4CAF50;
        }

        body.dark-mode .stat-box h3 {
            color: #eee;
        }

        body.dark-mode .stat-box p {
            color: #4CAF50;
        }

        body.dark-mode .stat-box small {
            color: #aaa;
        }

        /* ===== ACTIVIDAD RECIENTE ===== */
        .recent-activity {
            margin-top: 20px;
        }

        .activity-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        .activity-list li {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
        }

        .activity-list li:before {
            content: "‚Ä¢";
            color: #2E7D32;
            font-weight: bold;
            display: inline-block;
            width: 1em;
            margin-right: 10px;
        }

        .activity-list li:hover {
            background-color: #f5f5f5;
        }

        body.dark-mode .activity-list li {
            border-bottom-color: #444;
        }

        body.dark-mode .activity-list li:hover {
            background-color: #333;
        }

        body.dark-mode .activity-list li:before {
            color: #4CAF50;
        }

        /* ===== ACCIONES DEL ADMINISTRADOR ===== */
        .admin-actions {
            display: flex;
            justify-content: flex-start;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .admin-actions button {
            background-color: #2E7D32;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .admin-actions button:hover {
            background-color: #1B5E20;
            transform: scale(1.05);
        }

        /* ===== LISTADO DE GRUPOS ===== */
        #group-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        /* ===== ESTILOS MEJORADOS PARA GRUPOS ===== */
        .group-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border-left: 5px solid #2E7D32;
            overflow: hidden;
            position: relative;
        }

        body.dark-mode .group-container {
            background-color: #252525;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
            border-left-color: #4CAF50;
        }

        .group-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.15);
        }

        .group-container h3 {
            color: #2E7D32;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
        }

        body.dark-mode .group-container h3 {
            color: #4CAF50;
            border-bottom-color: #444;
        }

        .group-container h3:before {
            content: "üìö";
            margin-right: 10px;
            font-size: 1.2em;
        }

        /* Cabecera del grupo */
        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .group-info {
            display: flex;
            gap: 10px;
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        body.dark-mode .group-info {
            color: #aaa;
        }

        .group-info span {
            background-color: #f0f0f0;
            padding: 4px 8px;
            border-radius: 4px;
            display: flex;
            align-items: center;
        }

        body.dark-mode .group-info span {
            background-color: #333;
        }

        /* Tarjetas de maestros y materias mejoradas */
        .teacher-card, .subject-card {
            background-color: #f9f9f9;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
            border-left: 3px solid #4CAF50;
        }

        body.dark-mode .teacher-card,
        body.dark-mode .subject-card {
            background-color: #333;
            border-left-color: #81C784;
        }

        .teacher-card:hover, .subject-card:hover {
            transform: translateX(5px);
        }

        .teacher-info {
            flex: 1;
            min-width: 0;
        }

        .teacher-details {
            margin-top: 5px;
            font-size: 0.85em;
            color: #555;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        body.dark-mode .teacher-details {
            color: #bbb;
        }

        .teacher-details div {
            display: flex;
            align-items: center;
        }

        .teacher-details i {
            margin-right: 5px;
            font-size: 0.9em;
        }

        /* Botones de acci√≥n */
        .group-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .group-actions button {
            background-color: #2E7D32;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .group-actions button:hover {
            background-color: #1B5E20;
            transform: translateY(-2px);
        }

        body.dark-mode .group-actions button {
            background-color: #4CAF50;
        }

        body.dark-mode .group-actions button:hover {
            background-color: #45a049;
        }

        /* Contador de alumnos */
        .alumnos-count {
            position: absolute;
            top: 15px;
            right: 15px;
            background-color: #2E7D32;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: bold;
        }

        body.dark-mode .alumnos-count {
            background-color: #4CAF50;
        }

        /* Badges para informaci√≥n */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 500;
            margin-right: 8px;
            background-color: #e8f5e9;
            color: #2E7D32;
        }

        body.dark-mode .badge {
            background-color: #1B5E20;
            color: #e8f5e9;
        }

        /* Animaci√≥n de carga */
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        .loading-card {
            animation: pulse 1.5s infinite;
        }

        /* Tablas mejoradas */
        .table-container {
            overflow-x: auto;
            margin-bottom: 20px;
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .groups-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            border-radius: 8px;
            overflow: hidden;
            min-width: 600px;
            font-size: 0.9em;
        }

        .groups-table th,
        .groups-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        body.dark-mode .groups-table th,
        body.dark-mode .groups-table td {
            border-bottom: 1px solid #444;
        }

        .groups-table th {
            background-color: #2E7D32;
            color: white;
            font-weight: 500;
        }

        body.dark-mode .groups-table th {
            background-color: #4CAF50;
        }

        .groups-table tr:hover {
            background-color: #f5f5f5;
        }

        body.dark-mode .groups-table tr:hover {
            background-color: #333;
        }

        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #d32f2f;
            font-size: 1.1em;
            transition: transform 0.2s;
        }

        .action-btn:hover {
            transform: scale(1.2);
        }

        body.dark-mode .action-btn {
            color: #ff6b6b;
        }

        .password-cell {
            font-family: monospace;
            font-size: 0.9em;
        }

        /* Estados vac√≠os */
        .empty-state {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
            background-color: #fafafa;
            border-radius: 8px;
            border: 1px dashed #ddd;
        }
        
        body.dark-mode .empty-state {
            background-color: #2a2a2a;
            color: #aaa;
            border-color: #444;
        }

        /* ===== IMPORTACI√ìN/EXPORTACI√ìN ===== */
        .import-export-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .file-input-container {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-button {
            background-color: #2E7D32;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .file-input-button:hover {
            background-color: #1B5E20;
            transform: scale(1.05);
        }

        .file-input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        /* ===== PIE DE P√ÅGINA ===== */
        footer {
            text-align: center;
            padding: 10px;
            background-color: #2E7D32;
            color: white;
            position: fixed;
            width: 100%;
            bottom: 0;
            font-size: 0.9rem;
            animation: slideUp 0.5s ease-in-out;
        }

        body.dark-mode footer {
            background-color: #1B5E20;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        /* ===== ESTILOS RESPONSIVOS ===== */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                padding: 10px;
            }
            .header-buttons {
                flex-direction: column;
                gap: 5px;
            }
            .logout-button {
                margin-left: 0;
            }
            .admin-actions {
                flex-direction: column;
                gap: 10px;
            }
            .content-box {
                padding: 15px;
            }
            #group-list {
                grid-template-columns: 1fr;
            }
            .group-details {
                flex-direction: column;
            }
            .teachers-section, .subjects-section {
                min-width: 100%;
            }
            .import-export-actions {
                flex-direction: column;
            }
            .groups-table th, .groups-table td {
                padding: 8px;
                font-size: 0.85rem;
            }
        }

        /* Men√∫ Hamburguesa */
        .menu-icon {
            display: none;
            font-size: 24px;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .menu-icon {
                display: block;
            }
            .header-buttons {
                display: none;
            }
            .header-buttons.active {
                display: flex;
                flex-direction: column;
                position: absolute;
                top: 60px;
                right: 20px;
                background-color: #2E7D32;
                padding: 10px;
                border-radius: 5px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }
        }
    </style>
</head>
<body onload="cargarAdminDatos()">
    <!-- Barra de encabezado -->
    <header>
        <h1 id="admin-name">Panel de Administraci√≥n</h1>
        <div class="menu-icon" onclick="toggleMenu()">‚ò∞</div>
        <div class="header-buttons" id="header-buttons">
            <input type="text" id="search-input" placeholder="Buscar alumno..." oninput="buscarAlumno()" aria-label="Buscar alumno">
            <button class="dark-mode-toggle" onclick="toggleDarkMode()" aria-label="Cambiar modo oscuro">üåô</button>
            <button class="logout-button" onclick="logout()" aria-label="Cerrar sesi√≥n">Cerrar Sesi√≥n</button>
        </div>
    </header>

    <!-- Contenido Principal -->
    <main>
        <!-- Breadcrumbs para navegaci√≥n -->
        <div class="breadcrumbs">
            <span>Panel de Administraci√≥n</span> > <span id="current-section">Dashboard</span>
        </div>

        <!-- Dashboard con Resumen General Mejorado -->
        <section class="content-box">
            <h2 onclick="updateBreadcrumb('Dashboard')">Resumen General</h2>
            <div class="dashboard-stats">
                <div class="stat-box">
                    <i class="stat-icon">üë•</i>
                    <h3>Grupos</h3>
                    <p id="total-grupos">0</p>
                    <small id="grupos-change">Cargando...</small>
                </div>
                <div class="stat-box highlight">
                    <i class="stat-icon">üë®‚Äçüè´</i>
                    <h3>Maestros</h3>
                    <p id="total-maestros">0</p>
                    <small id="maestros-change">Cargando...</small>
                </div>
                <div class="stat-box">
                    <i class="stat-icon">üìö</i>
                    <h3>Materias</h3>
                    <p id="total-materias">0</p>
                    <small id="materias-change">Cargando...</small>
                </div>
                <div class="stat-box warning">
                    <i class="stat-icon">üéì</i>
                    <h3>Alumnos</h3>
                    <p id="total-alumnos">0</p>
                    <small id="alumnos-change">Cargando...</small>
                </div>
            </div>

            <!-- Gr√°fico de alumnos por grupo -->
            <div style="margin-top: 30px;">
                <canvas id="chart-alumnos-por-grupo"></canvas>
            </div>

            <!-- Actividad reciente -->
            <div class="recent-activity">
                <h3>Actividad Reciente</h3>
                <ul class="activity-list" id="activity-list">
                    <li>Cargando actividad reciente...</li>
                </ul>
            </div>
        </section>

        <!-- Gesti√≥n de Grupos y Alumnos -->
        <section class="content-box">
            <h2 onclick="updateBreadcrumb('Gesti√≥n de Grupos')">Gesti√≥n de Grupos y Alumnos</h2>
            <div class="admin-actions">
                <button onclick="addGroup()" aria-label="Agregar grupo">Agregar Grupo</button>
                <button onclick="removeGroup()" aria-label="Quitar grupo">Quitar Grupo</button>
                <button onclick="addTeacher()" aria-label="Agregar maestro">Agregar Maestro</button>
                <button onclick="addSubject()" aria-label="Agregar materia">Agregar Materia</button>
            </div>

            <div class="import-export-actions">
                <button onclick="exportarDatos()" aria-label="Exportar datos">Exportar Datos</button>
                <div class="file-input-container">
                    <button class="file-input-button">Importar desde Excel</button>
                    <input type="file" id="excel-import" class="file-input" accept=".xlsx, .xls" onchange="importarExcel(event)">
                </div>
            </div>

            <div id="group-list">
                <!-- Aqu√≠ se insertar√°n din√°micamente los grupos -->
            </div>
        </section>

        <!-- Reportes y Estad√≠sticas -->
        <section class="content-box">
            <h2 onclick="updateBreadcrumb('Reportes')">Reportes y Estad√≠sticas</h2>
            <div id="report-list">
                <!-- Aqu√≠ se insertar√°n din√°micamente los reportes -->
            </div>
        </section>
    </main>

    <!-- Pie de p√°gina -->
    <footer>
        <p>&copy; 2025 CBT Profesor Luis Camarena Gonz√°lez</p>
    </footer>

    <script>
        // ===== VARIABLES GLOBALES =====
        let lastData = {
            grupos: 0,
            maestros: 0,
            materias: 0,
            alumnos: 0
        };

        // ===== FUNCIONES DE INTERFAZ =====

        /**
         * Muestra notificaciones al usuario usando SweetAlert2
         * @param {string} titulo - T√≠tulo de la notificaci√≥n
         * @param {string} mensaje - Mensaje a mostrar
         * @param {string} tipo - Tipo de notificaci√≥n (success, error, warning, info)
         */
        function mostrarNotificacion(titulo, mensaje, tipo) {
            Swal.fire({
                title: titulo,
                text: mensaje,
                icon: tipo,
                confirmButtonText: 'OK',
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });
        }

        /**
         * Actualiza la barra de breadcrumb con la secci√≥n actual
         * @param {string} section - Nombre de la secci√≥n actual
         */
        function updateBreadcrumb(section) {
            document.getElementById('current-section').textContent = section;
        }

        /**
         * Alterna entre modo oscuro y claro
         */
        function toggleDarkMode() {
            const body = document.body;
            const darkModeToggle = document.querySelector('.dark-mode-toggle');
            body.classList.toggle('dark-mode');
            const isDarkMode = body.classList.contains('dark-mode');
            localStorage.setItem('dark-mode', isDarkMode);

            // Cambiar el √≠cono del bot√≥n seg√∫n el modo actual
            darkModeToggle.textContent = isDarkMode ? 'üåû' : 'üåô';
            mostrarNotificacion("Modo " + (isDarkMode ? "oscuro" : "claro"), 
                              "El tema se ha cambiado correctamente", 
                              "success");
        }

        /**
         * Muestra/oculta el men√∫ en dispositivos m√≥viles
         */
        function toggleMenu() {
            const headerButtons = document.getElementById('header-buttons');
            headerButtons.classList.toggle('active');
        }

        // ===== FUNCIONES DE SESI√ìN MEJORADAS =====
        
        /**
         * Verifica la sesi√≥n del administrador
         */
        function verificarSesionAdmin() {
            let urlParams = new URLSearchParams(window.location.search);
            let adminEmail = urlParams.get('admin');
            
            if (!adminEmail) {
                mostrarNotificacion("Error", "No has iniciado sesi√≥n.", "error");
                setTimeout(() => {
                    window.location.href = "index.html";
                }, 2000);
                return false;
            }
            return true;
        }

        // ===== FUNCIONES PRINCIPALES MEJORADAS =====

        /**
         * Carga los datos del administrador y actualiza la interfaz
         */
        function cargarAdminDatos() {
            if (!verificarSesionAdmin()) return;
            
            let urlParams = new URLSearchParams(window.location.search);
            let adminEmail = urlParams.get('admin');
            document.getElementById("admin-name").textContent = `Bienvenido, ${adminEmail}`;
            
            cargarGrupos();
            cargarMaestros();
            cargarMaterias();
            actualizarResumen();
            cargarGraficoAlumnosPorGrupo();
            cargarActividadReciente();
            updateBreadcrumb('Dashboard');
        }

        /**
         * Carga y muestra la lista de grupos desde localStorage (versi√≥n mejorada)
         */
        function cargarGrupos() {
            if (!verificarSesionAdmin()) return;
            
            let groupContainer = document.getElementById("group-list");
            groupContainer.innerHTML = "";
            let grupos = JSON.parse(localStorage.getItem("grupos")) || [];
            let maestros = JSON.parse(localStorage.getItem("maestros")) || [];
            let materias = JSON.parse(localStorage.getItem("materias")) || [];

            if (grupos.length === 0) {
                groupContainer.innerHTML = '<div class="empty-state">No hay grupos registrados. Crea tu primer grupo usando el bot√≥n "Agregar Grupo"</div>';
                return;
            }

            grupos.forEach(grupo => {
                let groupElement = document.createElement("div");
                groupElement.classList.add("group-container");
                
                // Obtener maestros asignados a este grupo (versi√≥n mejorada)
                let maestrosAsignados = [];
                if (grupo.maestros && grupo.maestros.length > 0) {
                    maestrosAsignados = maestros.filter(m => grupo.maestros.includes(m.id));
                }
                
                // Obtener materias asignadas a este grupo
                let materiasAsignadas = [];
                if (grupo.materias && grupo.materias.length > 0) {
                    materiasAsignadas = materias.filter(m => grupo.materias.includes(m.id));
                }
                
                groupElement.innerHTML = 
                    `<div class="group-header">
                        <h3>${grupo.nombre}</h3>
                        <div class="alumnos-count">${grupo.alumnos ? grupo.alumnos.length : 0}</div>
                    </div>
                    
                    <div class="group-info">
                        <span><i>üè´</i> ${grupo.carrera}</span>
                        <span><i>üìÖ</i> ${grupo.grado}¬∞</span>
                        <span><i>üî§</i> Grupo ${grupo.grupo}</span>
                    </div>
                    
                    <div class="table-container">
                        <table class="groups-table">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Matr√≠cula</th>
                                    <th>Correo</th>
                                    <th>Contrase√±a</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="${grupo.id}">
                                ${grupo.alumnos ? grupo.alumnos.map(alumno => `
                                    <tr>
                                        <td>${alumno.nombre}</td>
                                        <td>${alumno.matricula}</td>
                                        <td>${alumno.email}</td>
                                        <td class="password-cell">${alumno.password}</td>
                                        <td>
                                            <button onclick="removeStudent('${grupo.id}', '${alumno.matricula}')" 
                                                    class="action-btn" 
                                                    aria-label="Quitar alumno">
                                                üóëÔ∏è
                                            </button>
                                        </td>
                                    </tr>`
                                ).join('') : '<tr><td colspan="5">No hay alumnos registrados</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="group-details">
                        <div class="teachers-section">
                            <div class="section-title">üë®‚Äçüè´ Maestros Asignados <span class="badge">${maestrosAsignados.length}</span></div>
                            ${maestrosAsignados.length > 0 ? 
                                maestrosAsignados.map(maestro => `
                                    <div class="teacher-card">
                                        <div class="teacher-info">
                                            <div><strong>${maestro.nombre}</strong></div>
                                            <div class="teacher-details">
                                                <div><i>üìö</i> ${maestro.materia || 'Sin materia'}</div>
                                                <div><i>‚úâÔ∏è</i> ${maestro.email}</div>
                                                <div><i>üîë</i> ${maestro.password}</div>
                                            </div>
                                        </div>
                                        <div class="teacher-actions">
                                            <button onclick="desasignarMaestro('${grupo.id}', '${maestro.id}')" 
                                                    class="action-btn" 
                                                    aria-label="Quitar maestro">
                                                üóëÔ∏è
                                            </button>
                                        </div>
                                    </div>`
                                ).join('') : 
                                '<div class="empty-state">No hay maestros asignados</div>'
                            }
                        </div>
                        
                        <div class="subjects-section">
                            <div class="section-title">üìö Materias <span class="badge">${materiasAsignadas.length}</span></div>
                            ${materiasAsignadas.length > 0 ? 
                                materiasAsignadas.map(materia => `
                                    <div class="subject-card">
                                        <div class="subject-info">${materia.nombre}</div>
                                        <div class="subject-actions">
                                            <button onclick="desasignarMateria('${grupo.id}', '${materia.id}')" 
                                                    class="action-btn" 
                                                    aria-label="Quitar materia">
                                                üóëÔ∏è
                                            </button>
                                        </div>
                                    </div>`
                                ).join('') : 
                                '<div class="empty-state">No hay materias asignadas</div>'
                            }
                        </div>
                    </div>
                    
                    <div class="group-actions">
                        <button onclick="addStudent('${grupo.id}')">
                            <span>‚ûï</span> Agregar Alumno
                        </button>
                        <button onclick="asignarMaestro('${grupo.id}')">
                            <span>üë®‚Äçüè´</span> Asignar Maestro
                        </button>
                        <button onclick="asignarMateria('${grupo.id}')">
                            <span>üìö</span> Agregar Materia
                        </button>
                    </div>`;
                
                groupContainer.appendChild(groupElement);
            });
        }

        /**
         * Carga los maestros desde localStorage (para uso interno)
         * @returns {Array} Lista de maestros
         */
        function cargarMaestros() {
            if (!verificarSesionAdmin()) return [];
            return JSON.parse(localStorage.getItem("maestros")) || [];
        }

        /**
         * Carga las materias desde localStorage (para uso interno)
         * @returns {Array} Lista de materias
         */
        function cargarMaterias() {
            if (!verificarSesionAdmin()) return [];
            return JSON.parse(localStorage.getItem("materias")) || [];
        }

        /**
         * Carga y muestra la actividad reciente desde localStorage
         */
        function cargarActividadReciente() {
            if (!verificarSesionAdmin()) return;
            
            let actividad = JSON.parse(localStorage.getItem("actividad")) || [];
            let lista = document.getElementById("activity-list");
            
            if (actividad.length === 0) {
                lista.innerHTML = "<li>No hay actividad reciente para mostrar</li>";
                return;
            }
            
            // Limitar a 5 elementos y ordenar del m√°s reciente al m√°s antiguo
            actividad = actividad.slice(-5).reverse();
            lista.innerHTML = actividad.map(item => `<li>${item}</li>`).join('');
        }

        /**
         * Registra una nueva actividad en el historial
         * @param {string} accion - Descripci√≥n de la acci√≥n realizada
         */
        function registrarActividad(accion) {
            if (!verificarSesionAdmin()) return;
            
            let actividad = JSON.parse(localStorage.getItem("actividad")) || [];
            let fecha = new Date().toLocaleString();
            actividad.push(`${fecha}: ${accion}`);
            
            // Limitar el historial a 50 elementos
            if (actividad.length > 50) {
                actividad = actividad.slice(-50);
            }
            
            localStorage.setItem("actividad", JSON.stringify(actividad));
            cargarActividadReciente();
        }

        // ===== FUNCIONES DE GESTI√ìN =====

        /**
         * Actualiza el resumen general con datos actuales
         */
        function actualizarResumen() {
            if (!verificarSesionAdmin()) return;
            
            let grupos = JSON.parse(localStorage.getItem("grupos")) || [];
            let maestros = JSON.parse(localStorage.getItem("maestros")) || [];
            let materias = JSON.parse(localStorage.getItem("materias")) || [];
            
            // Calcular totales
            let totalGrupos = grupos.length;
            let totalMaestros = maestros.length;
            let totalMaterias = materias.length;
            let totalAlumnos = grupos.reduce((total, grupo) => total + (grupo.alumnos ? grupo.alumnos.length : 0), 0);
            
            // Actualizar UI
            document.getElementById("total-grupos").textContent = totalGrupos;
            document.getElementById("total-maestros").textContent = totalMaestros;
            document.getElementById("total-materias").textContent = totalMaterias;
            document.getElementById("total-alumnos").textContent = totalAlumnos;
            
            // Calcular cambios desde la √∫ltima actualizaci√≥n
            actualizarCambios(totalGrupos, totalMaestros, totalMaterias, totalAlumnos);
            
            // Guardar datos actuales para la pr√≥xima comparaci√≥n
            lastData = {
                grupos: totalGrupos,
                maestros: totalMaestros,
                materias: totalMaterias,
                alumnos: totalAlumnos
            };
        }

        /**
         * Calcula y muestra los cambios desde la √∫ltima actualizaci√≥n
         */
        function actualizarCambios(grupos, maestros, materias, alumnos) {
            if (!verificarSesionAdmin()) return;
            
            // Grupos
            let diffGrupos = grupos - lastData.grupos;
            let gruposText = diffGrupos > 0 ? `+${diffGrupos} esta semana` : 
                            diffGrupos < 0 ? `${diffGrupos} esta semana` : 'Sin cambios';
            document.getElementById("grupos-change").textContent = gruposText;
            
            // Maestros
            let diffMaestros = maestros - lastData.maestros;
            let maestrosText = diffMaestros > 0 ? `+${diffMaestros} nuevos` : 
                              diffMaestros < 0 ? `${diffMaestros} menos` : 'Sin cambios';
            document.getElementById("maestros-change").textContent = maestrosText;
            
            // Materias
            let diffMaterias = materias - lastData.materias;
            let materiasText = diffMaterias > 0 ? `+${diffMaterias} nuevas` : 
                              diffMaterias < 0 ? `${diffMaterias} menos` : 'Sin cambios';
            document.getElementById("materias-change").textContent = materiasText;
            
            // Alumnos
            let diffAlumnos = alumnos - lastData.alumnos;
            let alumnosText = diffAlumnos > 0 ? `+${diffAlumnos} nuevos` : 
                             diffAlumnos < 0 ? `${diffAlumnos} menos` : 'Sin cambios';
            document.getElementById("alumnos-change").textContent = alumnosText;
        }

        /**
         * Carga y muestra el gr√°fico de alumnos por grupo
         */
        function cargarGraficoAlumnosPorGrupo() {
            if (!verificarSesionAdmin()) return;
            
            let grupos = JSON.parse(localStorage.getItem("grupos")) || [];
            let ctx = document.getElementById('chart-alumnos-por-grupo').getContext('2d');
            let labels = grupos.map(grupo => grupo.nombre);
            let data = grupos.map(grupo => grupo.alumnos ? grupo.alumnos.length : 0);
            
            // Si ya existe un gr√°fico, destruirlo antes de crear uno nuevo
            if (window.alumnosChart) {
                window.alumnosChart.destroy();
            }
            
            window.alumnosChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Alumnos por Grupo',
                        data: data,
                        backgroundColor: '#2E7D32',
                        borderColor: '#1B5E20',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.raw}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Cantidad de Alumnos'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Grupos'
                            }
                        }
                    }
                }
            });
        }

        /**
         * Cierra la sesi√≥n del administrador
         */
        function logout() {
            Swal.fire({
                title: '¬øCerrar sesi√≥n?',
                text: '¬øEst√°s seguro de que deseas cerrar sesi√≥n?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'S√≠, cerrar sesi√≥n',
                cancelButtonText: 'Cancelar',
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = "index.html";
                }
            });
        }

        // ===== FUNCIONES PARA GRUPOS =====

        /**
         * Agrega un nuevo grupo al sistema
         */
        function addGroup() {
            if (!verificarSesionAdmin()) return;
            
            Swal.fire({
                title: 'Agregar Grupo',
                html: `
                    <input type="text" id="group-name" class="swal2-input" placeholder="Nombre del Grupo">
                    <select id="group-carrera" class="swal2-input">
                        <option value="Inform√°tica">Inform√°tica</option>
                        <option value="Administraci√≥n">Administraci√≥n</option>
                        <option value="Contabilidad">Contabilidad</option>
                        <option value="Electr√≥nica">Electr√≥nica</option>
                    </select>
                    <select id="group-grado" class="swal2-input">
                        <option value="1">1¬∞</option>
                        <option value="2">2¬∞</option>
                        <option value="3">3¬∞</option>
                        <option value="4">4¬∞</option>
                        <option value="5">5¬∞</option>
                        <option value="6">6¬∞</option>
                    </select>
                    <input type="text" id="group-grupo" class="swal2-input" placeholder="Grupo (Ej: A, B, C)">
                `,
                showCancelButton: true,
                confirmButtonText: 'Agregar',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    let nombreGrupo = document.getElementById('group-name').value;
                    let carrera = document.getElementById('group-carrera').value;
                    let grado = document.getElementById('group-grado').value;
                    let grupo = document.getElementById('group-grupo').value;
                    if (!nombreGrupo || !carrera || !grado || !grupo) {
                        Swal.showValidationMessage('Todos los campos son obligatorios.');
                    }
                    return { nombreGrupo, carrera, grado, grupo };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    let { nombreGrupo, carrera, grado, grupo } = result.value;
                    let grupos = JSON.parse(localStorage.getItem("grupos")) || [];
                    let grupoExistente = grupos.find(g => g.nombre === nombreGrupo);
                    if (grupoExistente) {
                        mostrarNotificacion("Error", "El grupo ya existe.", "error");
                        return;
                    }
                    let nuevoGrupo = { 
                        id: `grupo-${Date.now()}`, 
                        nombre: nombreGrupo, 
                        carrera: carrera, 
                        grado: grado, 
                        grupo: grupo, 
                        alumnos: [],
                        maestros: [],
                        materias: []
                    };
                    grupos.push(nuevoGrupo);
                    localStorage.setItem("grupos", JSON.stringify(grupos));
                    cargarGrupos();
                    actualizarResumen();
                    registrarActividad(`Grupo ${nombreGrupo} creado`);
                    mostrarNotificacion("√âxito", "Grupo agregado correctamente.", "success");
                }
            });
        }

        /**
         * Elimina un grupo del sistema
         */
        function removeGroup() {
            if (!verificarSesionAdmin()) return;
            
            Swal.fire({
                title: 'Eliminar Grupo',
                input: 'text',
                inputLabel: 'Nombre del Grupo',
                inputPlaceholder: 'Ingrese el nombre del grupo a eliminar',
                showCancelButton: true,
                confirmButtonText: 'Eliminar',
                cancelButtonText: 'Cancelar',
                inputValidator: (value) => {
                    if (!value) {
                        return 'El nombre del grupo no puede estar vac√≠o.';
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    let nombreGrupo = result.value;
                    Swal.fire({
                        title: '¬øEst√°s seguro?',
                        text: "¬°No podr√°s revertir esto!",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#2E7D32',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'S√≠, eliminar'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            let grupos = JSON.parse(localStorage.getItem("grupos")) || [];
                            grupos = grupos.filter(g => g.nombre !== nombreGrupo);
                            localStorage.setItem("grupos", JSON.stringify(grupos));
                            cargarGrupos();
                            actualizarResumen();
                            registrarActividad(`Grupo ${nombreGrupo} eliminado`);
                            mostrarNotificacion("√âxito", "Grupo eliminado correctamente.", "success");
                        }
                    });
                }
            });
        }

        // ===== FUNCIONES PARA ALUMNOS =====

        /**
         * Agrega un alumno a un grupo espec√≠fico
         * @param {string} groupId - ID del grupo al que se agregar√° el alumno
         */
        function addStudent(groupId) {
            if (!verificarSesionAdmin()) return;
            
            Swal.fire({
                title: 'Agregar Alumno',
                html: `
                    <input type="text" id="student-name" class="swal2-input" placeholder="Nombre del Alumno">
                    <input type="text" id="student-id" class="swal2-input" placeholder="Matr√≠cula del Alumno">
                `,
                showCancelButton: true,
                confirmButtonText: 'Agregar',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    let studentName = document.getElementById('student-name').value;
                    let studentId = document.getElementById('student-id').value;
                    if (!studentName || !studentId) {
                        Swal.showValidationMessage('Todos los campos son obligatorios.');
                    }
                    return { studentName, studentId };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    let { studentName, studentId } = result.value;
                    let grupos = JSON.parse(localStorage.getItem("grupos")) || [];
                    let grupo = grupos.find(g => g.id === groupId);
                    if (grupo) {
                        let alumnoExistente = grupo.alumnos ? grupo.alumnos.find(a => a.matricula === studentId) : false;
                        if (alumnoExistente) {
                            mostrarNotificacion("Error", "El alumno ya est√° registrado.", "error");
                            return;
                        }
                        // Generar correo y contrase√±a autom√°ticamente
                        let studentEmail = `al${studentId}@cbt.com`;
                        let studentPassword = generarContrase√±a();
                        
                        // Asegurarse de que el array de alumnos existe
                        grupo.alumnos = grupo.alumnos || [];
                        grupo.alumnos.push({ 
                            nombre: studentName, 
                            matricula: studentId, 
                            email: studentEmail, 
                            password: studentPassword 
                        });
                        // Ordenar alumnos por nombre
                        grupo.alumnos.sort((a, b) => a.nombre.localeCompare(b.nombre));
                        localStorage.setItem("grupos", JSON.stringify(grupos));
                        cargarGrupos();
                        actualizarResumen();
                        registrarActividad(`Alumno ${studentName} agregado al grupo ${grupo.nombre}`);
                        mostrarNotificacion("√âxito", "Alumno agregado correctamente.", "success");
                    }
                }
            });
        }

        /**
         * Elimina un alumno de un grupo
         * @param {string} groupId - ID del grupo
         * @param {string} studentId - Matr√≠cula del alumno a eliminar
         */
        function removeStudent(groupId, studentId) {
            if (!verificarSesionAdmin()) return;
            
            Swal.fire({
                title: '¬øEst√°s seguro?',
                text: "¬°No podr√°s revertir esto!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#2E7D32',
                cancelButtonColor: '#d33',
                confirmButtonText: 'S√≠, eliminar'
            }).then((result) => {
                if (result.isConfirmed) {
                    let grupos = JSON.parse(localStorage.getItem("grupos")) || [];
                    let grupo = grupos.find(g => g.id === groupId);
                    if (grupo && grupo.alumnos) {
                        let alumno = grupo.alumnos.find(a => a.matricula === studentId);
                        grupo.alumnos = grupo.alumnos.filter(alumno => alumno.matricula !== studentId);
                        localStorage.setItem("grupos", JSON.stringify(grupos));
                        cargarGrupos();
                        actualizarResumen();
                        if (alumno) {
                            registrarActividad(`Alumno ${alumno.nombre} eliminado del grupo ${grupo.nombre}`);
                        }
                        mostrarNotificacion("√âxito", "Alumno eliminado correctamente.", "success");
                    }
                }
            });
        }

        // ===== FUNCIONES PARA MAESTROS =====

        /**
         * Agrega un nuevo maestro al sistema
         */
        function addTeacher() {
            if (!verificarSesionAdmin()) return;
            
            Swal.fire({
                title: 'Agregar Maestro',
                html: `
                    <input type="text" id="teacher-name" class="swal2-input" placeholder="Nombre del Maestro">
                    <input type="text" id="teacher-subject" class="swal2-input" placeholder="Materia que imparte">
                `,
                showCancelButton: true,
                confirmButtonText: 'Agregar',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    let teacherName = document.getElementById('teacher-name').value;
                    let teacherSubject = document.getElementById('teacher-subject').value;
                    if (!teacherName) {
                        Swal.showValidationMessage('El nombre del maestro es obligatorio.');
                    }
                    return { teacherName, teacherSubject };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    let { teacherName, teacherSubject } = result.value;
                    let maestros = JSON.parse(localStorage.getItem("maestros")) || [];
                    // Generar correo y contrase√±a autom√°ticamente
                    let teacherEmail = `prof.${teacherName.toLowerCase().replace(/\s+/g, '.')}@cbt.com`;
                    let teacherPassword = generarContrase√±a();
                    let nuevoMaestro = { 
                        id: `maestro-${Date.now()}`, 
                        nombre: teacherName, 
                        email: teacherEmail, 
                        password: teacherPassword,
                        materia: teacherSubject || null
                    };
                    maestros.push(nuevoMaestro);
                    localStorage.setItem("maestros", JSON.stringify(maestros));
                    actualizarResumen();
                    registrarActividad(`Maestro ${teacherName} agregado al sistema`);
                    
                    // Mostrar informaci√≥n de acceso al maestro
                    Swal.fire({
                        title: 'Maestro agregado',
                        html: `
                            <p>Maestro creado exitosamente:</p>
                            <p><strong>Nombre:</strong> ${teacherName}</p>
                            <p><strong>Correo:</strong> ${teacherEmail}</p>
                            <p><strong>Contrase√±a:</strong> ${teacherPassword}</p>
                            <p><strong>Materia:</strong> ${teacherSubject || 'No asignada'}</p>
                        `,
                        icon: 'success'
                    });
                    
                    cargarGrupos(); // Actualizar la lista de grupos para mostrar el nuevo maestro
                }
            });
        }

        /**
         * Elimina un maestro del sistema
         * @param {string} teacherId - ID del maestro a eliminar
         */
        function removeTeacher(teacherId) {
            if (!verificarSesionAdmin()) return;
            
            Swal.fire({
                title: '¬øEst√°s seguro?',
                text: "¬°No podr√°s revertir esto!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#2E7D32',
                cancelButtonColor: '#d33',
                confirmButtonText: 'S√≠, eliminar'
            }).then((result) => {
                if (result.isConfirmed) {
                    let maestros = JSON.parse(localStorage.getItem("maestros")) || [];
                    let grupos = JSON.parse(localStorage.getItem("grupos")) || [];
                    
                    // Obtener nombre del maestro antes de eliminarlo
                    let maestro = maestros.find(m => m.id === teacherId);
                    let nombreMaestro = maestro ? maestro.nombre : "Maestro";
                    
                    // Eliminar el maestro
                    maestros = maestros.filter(m => m.id !== teacherId);
                    
                    // Quitar las asignaciones de este maestro a los grupos
                    grupos.forEach(grupo => {
                        if (grupo.maestros) {
                            grupo.maestros = grupo.maestros.filter(id => id !== teacherId);
                        }
                    });
                    
                    localStorage.setItem("maestros", JSON.stringify(maestros));
                    localStorage.setItem("grupos", JSON.stringify(grupos));
                    cargarGrupos();
                    actualizarResumen();
                    registrarActividad(`Maestro ${nombreMaestro} eliminado del sistema`);
                    mostrarNotificacion("√âxito", "Maestro eliminado correctamente.", "success");
                }
            });
        }

        /**
         * Asigna un maestro a un grupo espec√≠fico
         * @param {string} groupId - ID del grupo al que se asignar√° el maestro
         */
        function asignarMaestro(groupId) {
            if (!verificarSesionAdmin()) return;
            
            let maestros = JSON.parse(localStorage.getItem("maestros")) || [];
            let materias = JSON.parse(localStorage.getItem("materias")) || [];
            
            if (maestros.length === 0) {
                mostrarNotificacion("Error", "No hay maestros disponibles.", "error");
                return;
            }

            let options = maestros.map(maestro => {
                let materiaNombre = maestro.materia || 'Sin materia asignada';
                return `<option value="${maestro.id}">${maestro.nombre} (${materiaNombre})</option>`;
            }).join('');
            
            Swal.fire({
                title: 'Asignar Maestro al Grupo',
                html: `
                    <select id="teacher-select" class="swal2-select" style="width: 100%; margin-bottom: 10px;">
                        ${options}
                    </select>
                    <select id="subject-select" class="swal2-select" style="width: 100%;">
                        <option value="">Seleccionar materia (opcional)</option>
                        ${materias.map(materia => `<option value="${materia.id}">${materia.nombre}</option>`).join('')}
                    </select>
                `,
                showCancelButton: true,
                confirmButtonText: 'Asignar',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    let selectedTeacherId = document.getElementById('teacher-select').value;
                    let selectedSubjectId = document.getElementById('subject-select').value;
                    return { selectedTeacherId, selectedSubjectId };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    let { selectedTeacherId, selectedSubjectId } = result.value;
                    let grupos = JSON.parse(localStorage.getItem("grupos")) || [];
                    let grupo = grupos.find(g => g.id === groupId);
                    let maestros = JSON.parse(localStorage.getItem("maestros")) || [];
                    
                    if (grupo) {
                        // Verificar si el maestro ya est√° asignado
                        if (grupo.maestros && grupo.maestros.includes(selectedTeacherId)) {
                            mostrarNotificacion("Error", "Este maestro ya est√° asignado al grupo.", "error");
                            return;
                        }
                        
                        // Obtener nombre del maestro
                        let maestro = maestros.find(m => m.id === selectedTeacherId);
                        let nombreMaestro = maestro ? maestro.nombre : "Maestro";
                        
                        // Asignar maestro al grupo
                        grupo.maestros = grupo.maestros || [];
                        grupo.maestros.push(selectedTeacherId);
                        
                        // Asignar materia si se seleccion√≥ una
                        if (selectedSubjectId) {
                            grupo.materias = grupo.materias || [];
                            if (!grupo.materias.includes(selectedSubjectId)) {
                                grupo.materias.push(selectedSubjectId);
                            }
                            
                            // Actualizar la materia del maestro
                            let maestroIndex = maestros.findIndex(m => m.id === selectedTeacherId);
                            if (maestroIndex !== -1) {
                                let materia = materias.find(m => m.id === selectedSubjectId);
                                if (materia) {
                                    maestros[maestroIndex].materia = materia.nombre;
                                }
                            }
                        }
                        
                        localStorage.setItem("grupos", JSON.stringify(grupos));
                        localStorage.setItem("maestros", JSON.stringify(maestros));
                        cargarGrupos();
                        registrarActividad(`Maestro ${nombreMaestro} asignado al grupo ${grupo.nombre}`);
                        mostrarNotificacion("√âxito", "Maestro asignado correctamente.", "success");
                    }
                }
            });
        }

        /**
         * Desasigna un maestro de un grupo
         * @param {string} groupId - ID del grupo
         * @param {string} teacherId - ID del maestro a desasignar
         */
        function desasignarMaestro(groupId, teacherId) {
            if (!verificarSesionAdmin()) return;
            
            Swal.fire({
                title: '¬øDesasignar maestro?',
                text: "El maestro dejar√° de estar asignado a este grupo.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#2E7D32',
                cancelButtonColor: '#d33',
                confirmButtonText: 'S√≠, desasignar'
            }).then((result) => {
                if (result.isConfirmed) {
                    let grupos = JSON.parse(localStorage.getItem("grupos")) || [];
                    let grupo = grupos.find(g => g.id === groupId);
                    let maestros = JSON.parse(localStorage.getItem("maestros")) || [];
                    
                    if (grupo && grupo.maestros) {
                        // Obtener nombre del maestro antes de desasignarlo
                        let maestro = maestros.find(m => m.id === teacherId);
                        let nombreMaestro = maestro ? maestro.nombre : "Maestro";
                        
                        grupo.maestros = grupo.maestros.filter(id => id !== teacherId);
                        localStorage.setItem("grupos", JSON.stringify(grupos));
                        cargarGrupos();
                        registrarActividad(`Maestro ${nombreMaestro} desasignado del grupo ${grupo.nombre}`);
                        mostrarNotificacion("√âxito", "Maestro desasignado correctamente.", "success");
                    }
                }
            });
        }

        // ===== FUNCIONES PARA MATERIAS =====

        /**
         * Agrega una nueva materia al sistema
         */
        function addSubject() {
            if (!verificarSesionAdmin()) return;
            
            Swal.fire({
                title: 'Agregar Materia',
                html: `
                    <input type="text" id="subject-name" class="swal2-input" placeholder="Nombre de la Materia">
                    <select id="subject-carrera" class="swal2-input">
                        <option value="Inform√°tica">Inform√°tica</option>
                        <option value="Administraci√≥n">Administraci√≥n</option>
                        <option value="Contabilidad">Contabilidad</option>
                        <option value="Electr√≥nica">Electr√≥nica</option>
                    </select>
                `,
                showCancelButton: true,
                confirmButtonText: 'Agregar',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    let subjectName = document.getElementById('subject-name').value;
                    let subjectCarrera = document.getElementById('subject-carrera').value;
                    if (!subjectName || !subjectCarrera) {
                        Swal.showValidationMessage('Todos los campos son obligatorios.');
                    }
                    return { subjectName, subjectCarrera };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    let { subjectName, subjectCarrera } = result.value;
                    let materias = JSON.parse(localStorage.getItem("materias")) || [];
                    let materiaExistente = materias.find(m => m.nombre === subjectName && m.carrera === subjectCarrera);
                    if (materiaExistente) {
                        mostrarNotificacion("Error", "La materia ya existe en esta carrera.", "error");
                        return;
                    }
                    let nuevaMateria = { 
                        id: `materia-${Date.now()}`, 
                        nombre: subjectName,
                        carrera: subjectCarrera 
                    };
                    materias.push(nuevaMateria);
                    localStorage.setItem("materias", JSON.stringify(materias));
                    actualizarResumen();
                    registrarActividad(`Materia ${subjectName} agregada a la carrera ${subjectCarrera}`);
                    mostrarNotificacion("√âxito", "Materia agregada correctamente.", "success");
                }
            });
        }

        /**
         * Elimina una materia del sistema
         * @param {string} subjectId - ID de la materia a eliminar
         */
        function removeSubject(subjectId) {
            if (!verificarSesionAdmin()) return;
            
            Swal.fire({
                title: '¬øEst√°s seguro?',
                text: "¬°No podr√°s revertir esto!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#2E7D32',
                cancelButtonColor: '#d33',
                confirmButtonText: 'S√≠, eliminar'
            }).then((result) => {
                if (result.isConfirmed) {
                    let materias = JSON.parse(localStorage.getItem("materias")) || [];
                    let grupos = JSON.parse(localStorage.getItem("grupos")) || [];
                    
                    // Obtener nombre de la materia antes de eliminarla
                    let materia = materias.find(m => m.id === subjectId);
                    let nombreMateria = materia ? materia.nombre : "Materia";
                    let carreraMateria = materia ? materia.carrera : "";
                    
                    // Eliminar la materia
                    materias = materias.filter(m => m.id !== subjectId);
                    
                    // Quitar la materia de los grupos
                    grupos.forEach(grupo => {
                        if (grupo.materias) {
                            grupo.materias = grupo.materias.filter(id => id !== subjectId);
                        }
                    });
                    
                    // Quitar la materia de los maestros
                    let maestros = JSON.parse(localStorage.getItem("maestros")) || [];
                    if (materia) {
                        maestros.forEach(maestro => {
                            if (maestro.materia === materia.nombre) {
                                maestro.materia = null;
                            }
                        });
                    }
                    
                    localStorage.setItem("materias", JSON.stringify(materias));
                    localStorage.setItem("grupos", JSON.stringify(grupos));
                    localStorage.setItem("maestros", JSON.stringify(maestros));
                    cargarGrupos();
                    actualizarResumen();
                    registrarActividad(`Materia ${nombreMateria} eliminada de la carrera ${carreraMateria}`);
                    mostrarNotificacion("√âxito", "Materia eliminada correctamente.", "success");
                }
            });
        }

        /**
         * Asigna una materia a un grupo espec√≠fico
         * @param {string} groupId - ID del grupo al que se asignar√° la materia
         */
        function asignarMateria(groupId) {
            if (!verificarSesionAdmin()) return;
            
            let materias = JSON.parse(localStorage.getItem("materias")) || [];
            let grupos = JSON.parse(localStorage.getItem("grupos")) || [];
            let grupo = grupos.find(g => g.id === groupId);
            
            if (!grupo) return;
            
            // Filtrar materias que no est√©n ya asignadas
            let materiasDisponibles = materias.filter(m => !grupo.materias || !grupo.materias.includes(m.id));
            
            if (materiasDisponibles.length === 0) {
                mostrarNotificacion("Error", "No hay materias disponibles para asignar.", "error");
                return;
            }
            
            let options = materiasDisponibles.map(materia => 
                `<option value="${materia.id}">${materia.nombre}</option>`
            ).join('');
            
            Swal.fire({
                title: 'Asignar Materia al Grupo',
                html: `<select id="subject-select">${options}</select>`,
                showCancelButton: true,
                confirmButtonText: 'Asignar',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    return document.getElementById('subject-select').value;
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    let selectedSubjectId = result.value;
                    let materia = materias.find(m => m.id === selectedSubjectId);
                    let nombreMateria = materia ? materia.nombre : "Materia";
                    
                    grupo.materias = grupo.materias || [];
                    grupo.materias.push(selectedSubjectId);
                    localStorage.setItem("grupos", JSON.stringify(grupos));
                    cargarGrupos();
                    registrarActividad(`Materia ${nombreMateria} asignada al grupo ${grupo.nombre}`);
                    mostrarNotificacion("√âxito", "Materia asignada correctamente.", "success");
                }
            });
        }

        /**
         * Desasigna una materia de un grupo
         * @param {string} groupId - ID del grupo
         * @param {string} subjectId - ID de la materia a desasignar
         */
        function desasignarMateria(groupId, subjectId) {
            if (!verificarSesionAdmin()) return;
            
            Swal.fire({
                title: '¬øDesasignar materia?',
                text: "Esta materia dejar√° de estar asignada al grupo.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#2E7D32',
                cancelButtonColor: '#d33',
                confirmButtonText: 'S√≠, desasignar'
            }).then((result) => {
                if (result.isConfirmed) {
                    let grupos = JSON.parse(localStorage.getItem("grupos")) || [];
                    let grupo = grupos.find(g => g.id === groupId);
                    let materias = JSON.parse(localStorage.getItem("materias")) || [];
                    
                    if (grupo && grupo.materias) {
                        // Obtener nombre de la materia antes de desasignarla
                        let materia = materias.find(m => m.id === subjectId);
                        let nombreMateria = materia ? materia.nombre : "Materia";
                        
                        // Desasignar la materia
                        grupo.materias = grupo.materias.filter(id => id !== subjectId);
                        
                        // Desasignar maestros que solo ense√±aban esta materia
                        if (grupo.maestros) {
                            let maestros = JSON.parse(localStorage.getItem("maestros")) || [];
                            if (materia) {
                                grupo.maestros = grupo.maestros.filter(maestroId => {
                                    let maestro = maestros.find(m => m.id === maestroId);
                                    return !maestro || maestro.materia !== materia.nombre;
                                });
                            }
                        }
                        
                        localStorage.setItem("grupos", JSON.stringify(grupos));
                        cargarGrupos();
                        registrarActividad(`Materia ${nombreMateria} desasignada del grupo ${grupo.nombre}`);
                        mostrarNotificacion("√âxito", "Materia desasignada correctamente.", "success");
                    }
                }
            });
        }

        // ===== FUNCIONES DE B√öSQUEDA =====

        /**
         * Busca alumnos por nombre o matr√≠cula (con debounce)
         */
        let timeout;
        function buscarAlumno() {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                let searchTerm = document.getElementById('search-input').value.toLowerCase();
                let grupos = JSON.parse(localStorage.getItem("grupos")) || [];
                let resultados = [];
                grupos.forEach(grupo => {
                    if (grupo.alumnos) {
                        grupo.alumnos.forEach(alumno => {
                            if (alumno.nombre.toLowerCase().includes(searchTerm) || alumno.matricula.toLowerCase().includes(searchTerm)) {
                                resultados.push({ grupo: grupo.nombre, alumno });
                            }
                        });
                    }
                });
                mostrarResultados(resultados);
            }, 300);
        }

        /**
         * Muestra los resultados de b√∫squeda
         * @param {Array} resultados - Lista de alumnos que coinciden con la b√∫squeda
         */
        function mostrarResultados(resultados) {
            let groupContainer = document.getElementById("group-list");
            groupContainer.innerHTML = "";

            if (resultados.length === 0) {
                groupContainer.innerHTML = "<div class='empty-state'>No se encontraron resultados.</div>";
                return;
            }

            resultados.forEach(resultado => {
                let groupElement = document.createElement("div");
                groupElement.classList.add("group-container");
                groupElement.innerHTML = 
                    `<div class="group-header">
                        <h3>${resultado.grupo}</h3>
                    </div>
                    <div class="table-container">
                        <table class="groups-table">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Matr√≠cula</th>
                                    <th>Correo</th>
                                    <th>Contrase√±a</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>${resultado.alumno.nombre}</td>
                                    <td>${resultado.alumno.matricula}</td>
                                    <td>${resultado.alumno.email}</td>
                                    <td class="password-cell">${resultado.alumno.password}</td>
                                    <td>
                                        <button onclick="removeStudent('${resultado.grupo}', '${resultado.alumno.matricula}')" 
                                                class="action-btn" 
                                                aria-label="Quitar alumno">
                                            üóëÔ∏è
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>`;
                groupContainer.appendChild(groupElement);
            });
        }

        // ===== FUNCIONES DE IMPORTACI√ìN/EXPORTACI√ìN =====

        /**
         * Exporta los datos a un archivo Excel
         */
        function exportarDatos() {
            if (!verificarSesionAdmin()) return;
            
            let grupos = JSON.parse(localStorage.getItem("grupos")) || [];
            let maestros = JSON.parse(localStorage.getItem("maestros")) || [];
            let materias = JSON.parse(localStorage.getItem("materias")) || [];

            // Crear un libro de trabajo y una hoja
            let workbook = XLSX.utils.book_new();
            let worksheetData = [];

            // Encabezados
            worksheetData.push(["Grupo", "Nombre", "Matr√≠cula", "Correo", "Contrase√±a", "Maestro", "Materias"]);

            // Datos
            grupos.forEach(grupo => {
                let maestroNombres = "No asignado";
                if (grupo.maestros && grupo.maestros.length > 0) {
                    maestroNombres = grupo.maestros.map(maestroId => {
                        let maestro = maestros.find(m => m.id === maestroId);
                        return maestro ? maestro.nombre : '';
                    }).filter(Boolean).join(', ');
                }
                
                let materiaNombres = "No asignadas";
                if (grupo.materias && grupo.materias.length > 0) {
                    materiaNombres = grupo.materias.map(materiaId => {
                        let materia = materias.find(m => m.id === materiaId);
                        return materia ? materia.nombre : '';
                    }).filter(Boolean).join(', ');
                }
                
                if (grupo.alumnos) {
                    grupo.alumnos.forEach(alumno => {
                        worksheetData.push([
                            grupo.nombre,
                            alumno.nombre,
                            alumno.matricula,
                            alumno.email,
                            alumno.password,
                            maestroNombres,
                            materiaNombres
                        ]);
                    });
                }
            });

            // Convertir los datos en una hoja de trabajo
            let worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
            XLSX.utils.book_append_sheet(workbook, worksheet, "Alumnos");

            // Generar el archivo Excel
            XLSX.writeFile(workbook, "alumnos.xlsx");
            registrarActividad("Datos exportados a Excel");
        }

        /**
         * Importa datos desde un archivo Excel
         * @param {Event} event - Evento del input file
         */
        function importarExcel(event) {
            if (!verificarSesionAdmin()) return;
            
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // Procesar la primera hoja
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                
                if (jsonData.length === 0) {
                    mostrarNotificacion("Error", "El archivo est√° vac√≠o.", "error");
                    return;
                }

                Swal.fire({
                    title: 'Confirmar Importaci√≥n',
                    html: `Se importar√°n ${jsonData.length} registros. ¬øDeseas continuar?`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Importar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        procesarDatosExcel(jsonData);
                    }
                });
            };
            reader.readAsArrayBuffer(file);
        }

        /**
         * Procesa los datos importados desde Excel
         * @param {Array} data - Datos importados
         */
        function procesarDatosExcel(data) {
            if (!verificarSesionAdmin()) return;
            
            let grupos = JSON.parse(localStorage.getItem("grupos")) || [];
            let nuevosGrupos = {};
            let alumnosImportados = 0;
            
            try {
                data.forEach(row => {
                    const nombreGrupo = row['Grupo'];
                    if (!nombreGrupo) return;
                    
                    // Crear grupo si no existe
                    if (!nuevosGrupos[nombreGrupo] && !grupos.some(g => g.nombre === nombreGrupo)) {
                        nuevosGrupos[nombreGrupo] = {
                            id: `grupo-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                            nombre: nombreGrupo,
                            carrera: "Importada",
                            grado: "1",
                            grupo: "A",
                            alumnos: [],
                            maestros: [],
                            materias: []
                        };
                    }
                    
                    // Agregar alumno al grupo correspondiente
                    const grupo = grupos.find(g => g.nombre === nombreGrupo) || nuevosGrupos[nombreGrupo];
                    if (grupo && row['Nombre'] && row['Matr√≠cula']) {
                        grupo.alumnos = grupo.alumnos || [];
                        grupo.alumnos.push({
                            nombre: row['Nombre'],
                            matricula: row['Matr√≠cula'],
                            email: row['Correo'] || `al${row['Matr√≠cula']}@cbt.com`,
                            password: row['Contrase√±a'] || generarContrase√±a()
                        });
                        alumnosImportados++;
                    }
                });
                
                // Agregar los nuevos grupos a la lista existente
                Object.values(nuevosGrupos).forEach(nuevoGrupo => {
                    grupos.push(nuevoGrupo);
                });
                
                localStorage.setItem("grupos", JSON.stringify(grupos));
                cargarGrupos();
                actualizarResumen();
                registrarActividad(`Importados ${alumnosImportados} alumnos desde Excel`);
                mostrarNotificacion("√âxito", `Datos importados correctamente. ${alumnosImportados} alumnos agregados.`, "success");
            } catch (error) {
                console.error("Error al procesar el archivo:", error);
                mostrarNotificacion("Error", "Hubo un problema al procesar el archivo.", "error");
            }
            
            // Limpiar el input de archivo
            document.getElementById('excel-import').value = '';
        }

        // ===== FUNCIONES UTILITARIAS =====

        /**
         * Genera una contrase√±a aleatoria (solo letras y n√∫meros)
         * @returns {string} Contrase√±a generada
         */
        function generarContrase√±a() {
            const caracteres = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let contrase√±a = '';
            for (let i = 0; i < 10; i++) {
                contrase√±a += caracteres.charAt(Math.floor(Math.random() * caracteres.length));
            }
            return contrase√±a;
        }

        // ===== INICIALIZACI√ìN =====

        // Verificar el modo oscuro al cargar la p√°gina
        window.onload = function() {
            const body = document.body;
            const darkModeToggle = document.querySelector('.dark-mode-toggle');
            const isDarkMode = localStorage.getItem('dark-mode') === 'true';

            if (isDarkMode) {
                body.classList.add('dark-mode');
                darkModeToggle.textContent = 'üåû';
            } else {
                darkModeToggle.textContent = 'üåô';
            }

            cargarAdminDatos();
        };
    </script>
</body>
</html>